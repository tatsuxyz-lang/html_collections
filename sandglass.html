<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHAOS-GLASS - d(^_^o)</title>
    <style>
        body { background: #050505; color: #00ff41; font-family: monospace; margin: 0; overflow: hidden; touch-action: none; }
        #canvas { width: 100vw; height: 100vh; display: block; }
        .ui { position: fixed; top: 10px; left: 10px; pointer-events: none; opacity: 0.7; }
        .msg { position: fixed; bottom: 20px; right: 20px; font-size: 10px; opacity: 0.4; }
    </style>
</head>
<body>
    <div class="ui">
        <div>TIME: <span id="time-val">0</span></div>
        <div>ENERGY: <span id="energy-val">0</span></div>
    </div>
    <div class="msg">タップで「砂」を放流しろ。傾ければ流れる。るるるる。</div>
    <canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let width, height;

    function init() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', init);
    init();

    class Particle {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.vx = (Math.random() - 0.5) * 10;
            this.vy = (Math.random() - 0.5) * 10;
            this.size = Math.random() * 5 + 2;
            this.char = Math.random() > 0.5 ? '0' : '1';
        }
        update(gx, gy) {
            this.vx += gx;
            this.vy += gy;
            this.x += this.vx;
            this.y += this.vy;
            this.vx *= 0.98; // 摩擦
            this.vy *= 0.98;

            // 壁バウンド
            if (this.x < 0 || this.x > width) this.vx *= -0.8;
            if (this.y < 0 || this.y > height) this.vy *= -0.8;
            this.x = Math.max(0, Math.min(width, this.x));
            this.y = Math.max(0, Math.min(height, this.y));
        }
        draw() {
            ctx.fillStyle = '#00ff41';
            ctx.fillText(this.char, this.x, this.y);
        }
    }

    let gx = 0, gy = 0.5; // 標準重力
    window.addEventListener('deviceorientation', (e) => {
        // スマホを傾けると重力の向きが変わる
        gx = (e.gamma || 0) * 0.1;
        gy = (e.beta || 0) * 0.1;
    });

    canvas.addEventListener('pointerdown', (e) => {
        // タップした場所に「砂（ビット）」を大量生成
        for(let i=0; i<20; i++) {
            particles.push(new Particle(e.clientX, e.clientY));
        }
        if(navigator.vibrate) navigator.vibrate(20);
    });

    function loop() {
        ctx.fillStyle = 'rgba(5, 5, 5, 0.2)'; // 残像
        ctx.fillRect(0, 0, width, height);
        
        particles.forEach(p => {
            p.update(gx, gy);
            p.draw();
        });

        // 粒子が増えすぎたら古いものから消す（平穏のため）
        if (particles.length > 500) particles.shift();

        document.getElementById('time-val').innerText = particles.length;
        document.getElementById('energy-val').innerText = Math.floor(Math.abs(gx) + Math.abs(gy));
        
        requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>
