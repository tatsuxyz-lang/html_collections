<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHAOS-GLASS - d(^_^o)</title>
    <style>
        body { background: #050505; color: #00ff41; font-family: monospace; margin: 0; overflow: hidden; touch-wrap: none; touch-action: none; }
        #canvas { width: 100vw; height: 100vh; display: block; }
        .ui { position: fixed; top: 10px; left: 10px; pointer-events: none; opacity: 0.7; }
        .msg { position: fixed; bottom: 20px; right: 20px; font-size: 10px; opacity: 0.4; }
    </style>
</head>
<body>
    <div class="ui">
        <div>PARTICLES: <span id="time-val">0</span></div>
        <div>GRAVITY: <span id="energy-val">0</span></div>
    </div>
    <div class="msg">タップで「砂」を放流しろ。PCはクリック。るるるる。</div>
    <canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let width, height;

    function init() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', init);
    init();

    class Particle {
        
        draw() {
            ctx.fillStyle = '#00ff41';
            ctx.font = this.size + 'px monospace'; // フォントサイズを指定
            ctx.fillText(this.char, this.x, this.y);
        }
    }

    let gx = 0, gy = 0.5; 
    window.addEventListener('deviceorientation', (e) => {
        // iPhoneなどはここが動かないけど、それでOK！
        gx = (e.gamma || 0) * 0.1;
        gy = (e.beta || 0) * 0.1;
    });

    // タップやクリックで粒子を出す
    const addParticles = (e) => {
        const x = e.clientX || (e.touches && e.touches[0].clientX);
        const y = e.clientY || (e.touches && e.touches[0].clientY);
        for(let i=0; i<15; i++) {
            particles.push(new Particle(x, y));
        }
        if(navigator.vibrate) navigator.vibrate(20);
    };

    canvas.addEventListener('mousedown', addParticles);
    canvas.addEventListener('touchstart', addParticles);

    function loop() {
        ctx.fillStyle = 'rgba(5, 5, 5, 0.2)'; // 残像を残す
        ctx.fillRect(0, 0, width, height);
        
        particles.forEach(p => {
            p.update(gx, gy);
            p.draw();
        });

        if (particles.length > 300) particles.shift(); // 溜まりすぎ防止

        document.getElementById('time-val').innerText = particles.length;
        document.getElementById('energy-val').innerText = Math.floor(Math.abs(gx) + Math.abs(gy));
        
        requestAnimationFrame(loop);
    }
    // ★ここから差し込み：激しく振ったら全消去
    let lastX, lastY;
    window.addEventListener('devicemotion', (e) => {
        let acc = e.accelerationIncludingGravity;
        if (!acc) return;
        let delta = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY);
        if (delta > 50) { 
            particles = []; // 粒子全消去！
            if(navigator.vibrate) navigator.vibrate([50, 50, 50, 50]);
        }
        lastX = acc.x; lastY = acc.y;
    });
    // ★ここまで
    loop();
</script>
</body>
</html>
