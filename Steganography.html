<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ステガノ・エンコーダー</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: #fff; padding: 20px; }
        canvas { border: 2px solid #fff; image-rendering: pixelated; width: 256px; height: 256px; background: #000; }
        textarea { width: 90%; height: 60px; background: #222; color: #0f0; }
        .box { background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #444; }
    </style>
</head>
<body>
    <h1>STEGANO ENCODER</h1>
    
    <div class="box">
        <p>1. 画像選択</p>
        <input type="file" id="imageInput" accept="image/*">
    </div>

    <div class="box">
        <p>2. 隠したいメッセージ（英数字のみ推奨）</p>
        <input type="text" id="secretMsg" value="SECRET" style="width: 80%;">
    </div>

    <canvas id="preview" width="64" height="64"></canvas>

    <div class="box">
        <p>3. 生成されたパケット（これをQRへ）</p>
        <textarea id="outputString" readonly></textarea>
    </div>

    <div class="box">
    <a href="index.html">[HUBに戻る]</a>
    </div>

    <script>
        const canvas = document.getElementById('preview');
        const ctx = canvas.getContext('2d');
        const output = document.getElementById('outputString');

        document.getElementById('imageInput').onchange = (e) => {
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0, 64, 64);
                const imageData = ctx.getImageData(0, 0, 64, 64);
                const msg = document.getElementById('secretMsg').value;
                
                // メッセージを2進数に変換
                let binMsg = msg.split('').map(c => c.charCodeAt(0).toString(2).padStart(8, '0')).join('') + '11111111'; // 終了合図

                let hexStr = "";
                for (let i = 0; i < imageData.data.length / 4; i++) {
                    const avg = (imageData.data[i*4] + imageData.data[i*4+1] + imageData.data[i*4+2]) / 3;
                    let val4bit = Math.floor(avg / 16); // 0-15 (4bit)

                    // メッセージを1bitずつ埋め込む
                    if (binMsg.length > 0) {
                        const bit = binMsg[0];
                        binMsg = binMsg.substring(1);
                        // val4bitの偶数/奇数を調整して1bitを隠す
                        if (bit === "1" && val4bit % 2 === 0) val4bit++;
                        else if (bit === "0" && val4bit % 2 !== 0) val4bit--;
                    }
                    hexStr += val4bit.toString(16);
                }
                output.value = "STG64:" + hexStr;
            };
            img.src = URL.createObjectURL(e.target.files[0]);
        };
    </script>
</body>
</html>
